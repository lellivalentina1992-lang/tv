<!DOCTYPE html>
<html lang="it" class="h-full bg-black text-white">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TV/Radio ULTRA - 100% Diretto</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <style>
    /* Focus ultra-visibile per navigazione assistita */
    :focus {
      outline: 8px solid #fbbf24 !important;
      outline-offset: 4px;
      background-color: #1e40af !important;
    }
    .btn-ctrl { flex: 1 1 30%; min-height: 80px; font-weight: bold; font-size: 1.2rem; border-radius: 15px; transition: all 0.2s; }
    .btn-channel {
      width: 100%;
      text-align: left;
      background: #111827;
      padding: 1.4rem;
      border-radius: 18px;
      font-size: 1.6rem;
      border: 2px solid #374151;
      margin-bottom: 0.8rem;
      display: block;
    }
    .fav-active { border-color: #a855f7 !important; background: #2e1065 !important; }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }
  </style>
</head>

<body class="h-full flex flex-col font-sans overflow-hidden">

  <div id="sr-announcer" class="sr-only" aria-live="assertive" aria-atomic="true"></div>

  <main class="flex-1 flex flex-col p-4 overflow-hidden">
    
    <section class="mb-4" role="search">
      <label for="mainSearch" class="block text-xl font-bold mb-2 text-yellow-500">Cerca Canale (Ctrl+S):</label>
      <input
        type="search"
        id="mainSearch"
        class="w-full bg-gray-900 p-5 rounded-xl border-4 border-blue-600 text-white text-3xl focus:border-yellow-500"
        placeholder="Scrivi qui (es: Rai, Mediaset)..."
        autocomplete="off"
        autofocus
      />
    </section>

    <div class="flex-1 flex flex-col md:flex-row gap-4 overflow-hidden">
      
      <nav class="w-full md:w-1/3 flex flex-col overflow-hidden" aria-label="Elenco canali">
        <div id="statusArea" class="p-2 text-yellow-400 font-bold text-lg" aria-live="polite">
          Caricamento lista da GitHub...
        </div>
        <ul id="channelList" class="flex-1 overflow-y-auto pr-2" role="listbox"></ul>
      </nav>

      <section class="w-full md:w-2/3 bg-gray-900 rounded-xl border-4 border-gray-700 p-4 flex flex-col" aria-label="Riproduttore">
        <video id="videoPlayer" class="w-full bg-black mb-4 rounded-lg" style="max-height: 40vh;" controls crossorigin="anonymous"></video>

        <div class="flex flex-wrap gap-3">
          <button id="play-pause-btn" class="btn-ctrl bg-blue-700">Play/Pausa (K)</button>
          <button id="fav-toggle-btn" class="btn-ctrl bg-purple-700">Preferito (P)</button>
          <button id="sleep-btn" class="btn-ctrl bg-indigo-800">Timer 30 Min (T)</button>
          <button id="rewind-btn" class="btn-ctrl bg-orange-800">- 15 Sec (J)</button>
          <button id="forward-btn" class="btn-ctrl bg-orange-800">+ 15 Sec (L)</button>
          <button id="vol-up-btn" class="btn-ctrl bg-gray-700">Vol +</button>
          <button id="vol-down-btn" class="btn-ctrl bg-gray-700">Vol -</button>
        </div>
      </section>
    </div>
  </main>

  <script>
    // URL DIRETTO GITHUB (Senza passare dal server)
    const GITHUB_URL = "https://raw.githubusercontent.com/lellivalentina1992-lang/tv/refs/heads/main/lista_personale.m3u";

    const video = document.getElementById('videoPlayer');
    const statusArea = document.getElementById('statusArea');
    const srAnnouncer = document.getElementById('sr-announcer');
    const listContainer = document.getElementById('channelList');
    const mainSearch = document.getElementById('mainSearch');

    let allChannels = [];
    let favorites = JSON.parse(localStorage.getItem('tv_ultra_favs') || "[]");
    let hlsInstance = null;
    let sleepTimer = null;
    let currentCh = null;

    function announce(msg) {
      srAnnouncer.textContent = "";
      setTimeout(() => { srAnnouncer.textContent = msg; }, 100);
    }

    async function init() {
      try {
        const res = await fetch(GITHUB_URL);
        if (!res.ok) throw new Error();
        const data = await res.text();
        
        parseM3U(data);
        renderList("");
        
        // Caricamento volume salvato nel browser
        const savedVol = localStorage.getItem('tv_ultra_vol');
        if (savedVol !== null) video.volume = savedVol;

        statusArea.textContent = "Sistema Online. Caricato da GitHub.";
        announce("Lista canali pronta.");
      } catch (e) {
        announce("Errore nel caricamento della lista da GitHub.");
        statusArea.textContent = "Errore connessione.";
      }
    }

    function parseM3U(data) {
      allChannels = [];
      const lines = data.split('\n');
      let name = "";
      lines.forEach(line => {
        line = line.trim();
        if (line.startsWith("#EXTINF:")) {
          name = line.split(',').pop().trim();
        } else if (line.startsWith("http") && name) {
          allChannels.push({ name: name, url: line });
          name = "";
        }
      });
    }

    function renderList(query) {
      listContainer.innerHTML = "";
      const filtered = allChannels.filter(c => c.name.toLowerCase().includes(query.toLowerCase()));

      // Se non c'Ã¨ ricerca, mostra prima i preferiti salvati nel browser
      if (query === "" && favorites.length > 0) {
        const head = document.createElement('li');
        head.className = "text-purple-400 font-bold p-2 text-xl";
        head.textContent = "PREFERITI:";
        listContainer.appendChild(head);
        favorites.forEach(f => createButton(f, true));
        
        const headAll = document.createElement('li');
        headAll.className = "text-yellow-500 font-bold p-2 text-xl mt-4";
        headAll.textContent = "TUTTI I CANALI:";
        listContainer.appendChild(headAll);
      }

      filtered.slice(0, 100).forEach(ch => createButton(ch));
    }

    function createButton(ch, isFav = false) {
      const li = document.createElement('li');
      const btn = document.createElement('button');
      btn.className = "btn-channel" + (isFav ? " fav-active" : "");
      btn.textContent = ch.name;
      btn.onclick = () => playSource(ch);
      li.appendChild(btn);
      listContainer.appendChild(li);
    }

    async function playSource(ch) {
      currentCh = ch;
      statusArea.textContent = `Avvio: ${ch.name}`;
      announce(`In riproduzione: ${ch.name}`);

      if (hlsInstance) hlsInstance.destroy();

      if (ch.url.includes(".m3u8") && Hls.isSupported()) {
        hlsInstance = new Hls();
        hlsInstance.loadSource(ch.url);
        hlsInstance.attachMedia(video);
        hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => video.play());
      } else {
        video.src = ch.url;
        video.play().catch(() => announce("Errore di riproduzione sul link selezionato."));
      }
    }

    function toggleFavorite() {
      if (!currentCh) return announce("Seleziona prima un canale.");
      const index = favorites.findIndex(f => f.url === currentCh.url);
      if (index === -1) {
        favorites.push(currentCh);
        announce(`${currentCh.name} aggiunto ai preferiti.`);
      } else {
        favorites.splice(index, 1);
        announce(`${currentCh.name} rimosso.`);
      }
      localStorage.setItem('tv_ultra_favs', JSON.stringify(favorites));
      renderList(mainSearch.value);
    }

    function startTimer(min) {
      if (sleepTimer) clearTimeout(sleepTimer);
      announce(`Timer attivo: spegnimento tra ${min} minuti.`);
      sleepTimer = setTimeout(() => {
        video.pause();
        announce("Timer scaduto. Radio spenta.");
      }, min * 60000);
    }

    // --- CONTROLLI ---
    mainSearch.oninput = (e) => renderList(e.target.value);
    
    video.onvolumechange = () => localStorage.setItem('tv_ultra_vol', video.volume);

    document.getElementById('fav-toggle-btn').onclick = toggleFavorite;
    document.getElementById('sleep-btn').onclick = () => startTimer(30);
    document.getElementById('play-pause-btn').onclick = () => {
      if (video.paused) { video.play(); announce("Play"); }
      else { video.pause(); announce("Pausa"); }
    };

    window.addEventListener('keydown', (e) => {
      if (document.activeElement === mainSearch) {
        if (e.key === 'Enter') {
          const first = listContainer.querySelector('button');
          if (first) first.focus();
        }
        return;
      }
      
      switch(e.key.toLowerCase()) {
        case 'k': document.getElementById('play-pause-btn').click(); break;
        case 'p': toggleFavorite(); break;
        case 't': startTimer(30); break;
        case 'j': video.currentTime -= 15; announce("Indietro 15"); break;
        case 'l': video.currentTime += 15; announce("Avanti 15"); break;
        case 's': if (e.ctrlKey) { e.preventDefault(); mainSearch.focus(); announce("Cerca canale."); } break;
      }
    });

    document.getElementById('vol-up-btn').onclick = () => {
      video.volume = Math.min(1, video.volume + 0.1);
      announce(`Volume ${Math.round(video.volume * 100)} percento`);
    };
    document.getElementById('vol-down-btn').onclick = () => {
      video.volume = Math.max(0, video.volume - 0.1);
      announce(`Volume ${Math.round(video.volume * 100)} percento`);
    };

    init();
  </script>
</body>
</html>