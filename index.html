<script>
    const SERVER_IP = "http://138.199.196.24:3000";
    const TOKEN = "42944";
    const video = document.getElementById('videoPlayer');
    const srAnnouncer = document.getElementById('sr-announcer');
    const listContainer = document.getElementById('channelList');
    const mainSearch = document.getElementById('mainSearch');
    const statusArea = document.getElementById('statusArea');

    let allChannels = [];
    let favorites = JSON.parse(localStorage.getItem('tv_favorites') || "[]");
    let hlsInstance = null;
    let sleepTimer = null;
    let currentIndex = -1;
    let lastProgramInfo = "";

    function announce(msg) {
      srAnnouncer.textContent = "";
      setTimeout(() => { srAnnouncer.textContent = msg; }, 100);
    }

    // --- MEMORIA VOLUME ---
    video.onvolumechange = () => localStorage.setItem('tv_volume', video.volume);
    window.onload = () => {
      const savedVol = localStorage.getItem('tv_volume');
      if (savedVol !== null) video.volume = savedVol;
      mainSearch.focus();
    };

    async function init() {
      try {
        const urlM3U = "https://raw.githubusercontent.com/lellivalentina1992-lang/tv/refs/heads/main/lista_personale.m3u";
        const res = await fetch(`${SERVER_IP}/m3u?token=${TOKEN}&url=${encodeURIComponent(urlM3U)}`);
        const data = await res.text();
        parseM3U(data);
        renderList("");
        statusArea.textContent = "Sistema Online.";
      } catch (e) { announce("Errore di connessione."); }
    }

    function parseM3U(data) {
      allChannels = [];
      const lines = data.split('\n');
      let name = "";
      lines.forEach(line => {
        line = line.trim();
        if (line.startsWith("#EXTINF:")) name = line.split(',').pop().trim();
        else if (line.startsWith("http") && name) {
          allChannels.push({ pretty: name, url: line });
          name = "";
        }
      });
    }

    function renderList(query) {
      listContainer.innerHTML = "";
      let displayList = allChannels.filter(c => c.pretty.toLowerCase().includes(query.toLowerCase()));
      
      // Se non c'è ricerca, mostra i preferiti in alto
      if (query === "" && favorites.length > 0) {
        const favHeader = document.createElement('li');
        favHeader.className = "text-purple-400 font-bold p-2 text-xl";
        favHeader.textContent = "I TUOI PREFERITI:";
        listContainer.appendChild(favHeader);
        
        favorites.forEach(f => createChButton(f, true));
        
        const allHeader = document.createElement('li');
        allHeader.className = "text-yellow-500 font-bold p-2 text-xl mt-4";
        allHeader.textContent = "TUTTI I CANALI:";
        listContainer.appendChild(allHeader);
      }

      displayList.slice(0, 100).forEach(ch => createChButton(ch));
    }

    function createChButton(ch, isFav = false) {
      const li = document.createElement('li');
      const btn = document.createElement('button');
      btn.className = `btn-channel ${isFav ? 'border-purple-500 bg-gray-800' : ''}`;
      btn.textContent = ch.pretty;
      btn.onclick = () => {
        currentIndex = allChannels.findIndex(c => c.url === ch.url);
        playSource(ch.url, ch.pretty);
      };
      li.appendChild(btn);
      listContainer.appendChild(li);
    }

    async function playSource(url, nome) {
      statusArea.textContent = `Caricamento: ${nome}`;
      lastProgramInfo = `In riproduzione: ${nome}`;
      
      try {
        const infoRes = await fetch(`${SERVER_IP}/info-programma?token=${TOKEN}&nome=${encodeURIComponent(nome)}`);
        const infoData = await infoRes.json();
        if (infoData.titolo) {
          lastProgramInfo = `Su ${nome} c'è: ${infoData.titolo}`;
        }
      } catch (e) {}

      announce(lastProgramInfo);

      if (hlsInstance) hlsInstance.destroy();
      if (url.includes(".m3u8") && Hls.isSupported()) {
        hlsInstance = new Hls();
        hlsInstance.loadSource(url);
        hlsInstance.attachMedia(video);
        hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => video.play());
      } else {
        video.src = url;
        video.play().catch(() => announce("Errore file."));
      }
    }

    // --- LOGICA PREFERITI ---
    function toggleFavorite() {
      if (currentIndex === -1) return announce("Seleziona prima un canale.");
      const ch = allChannels[currentIndex];
      const idx = favorites.findIndex(f => f.url === ch.url);
      
      if (idx === -1) {
        favorites.push(ch);
        announce(`${ch.pretty} aggiunto ai preferiti.`);
      } else {
        favorites.splice(idx, 1);
        announce(`${ch.pretty} rimosso dai preferiti.`);
      }
      localStorage.setItem('tv_favorites', JSON.stringify(favorites));
      renderList(mainSearch.value);
    }

    // --- TASTI RAPIDI ---
    window.addEventListener('keydown', (e) => {
      if (document.activeElement === mainSearch) return;
      
      switch(e.key.toLowerCase()) {
        case 'p': toggleFavorite(); break;
        case 'i': announce(lastProgramInfo); break;
        case 'n': // Prossimo canale
          if (currentIndex < allChannels.length - 1) {
            currentIndex++;
            playSource(allChannels[currentIndex].url, allChannels[currentIndex].pretty);
          }
          break;
        case 'b': // Canale precedente
          if (currentIndex > 0) {
            currentIndex--;
            playSource(allChannels[currentIndex].url, allChannels[currentIndex].pretty);
          }
          break;
        case 'm':
        case '0':
          video.muted = !video.muted;
          announce(video.muted ? "Muto" : "Audio attivo");
          break;
        // ... (altre scorciatoie T, K, J, L già presenti)
      }
    });

    init();
  </script>