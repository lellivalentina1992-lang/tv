<!DOCTYPE html>
<html lang="it" class="h-full bg-black text-white">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TV/Radio ULTRA - Sistema Protetto 42944</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <style>
    /* Focus ultra-visibile ottimizzato per navigazione assistita */
    :focus {
      outline: 8px solid #fbbf24 !important;
      outline-offset: 4px;
      background-color: #1e40af !important;
    }
    .btn-ctrl { flex: 1 1 30%; min-height: 80px; font-weight: bold; font-size: 1.2rem; border-radius: 15px; transition: all 0.2s; }
    .btn-channel {
      width: 100%;
      text-align: left;
      background: #111827;
      padding: 1.4rem;
      border-radius: 18px;
      font-size: 1.6rem;
      border: 2px solid #374151;
      margin-bottom: 0.8rem;
      display: block;
    }
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }
  </style>
</head>

<body class="h-full flex flex-col font-sans overflow-hidden">

  <div id="sr-announcer" class="sr-only" aria-live="assertive" aria-atomic="true"></div>

  <main class="flex-1 flex flex-col p-4 overflow-hidden">
    <section class="mb-4" role="search">
      <label for="mainSearch" class="block text-xl font-bold mb-2 text-yellow-500">Cerca Canale (Ctrl+S):</label>
      <input
        type="search"
        id="mainSearch"
        class="w-full bg-gray-900 p-5 rounded-xl border-4 border-blue-600 text-white text-3xl focus:border-yellow-500"
        placeholder="Scrivi qui (es: Rai, Mediaset, Lazio)..."
        autocomplete="off"
      />
    </section>

    <div class="flex-1 flex flex-col md:flex-row gap-4 overflow-hidden">
      <section class="w-full md:w-1/3 flex flex-col overflow-hidden" aria-label="Elenco canali">
        <div id="statusArea" class="p-2 text-yellow-400 font-bold text-lg" aria-live="polite">
          Connessione al server Hetzner...
        </div>
        <ul id="channelList" class="flex-1 overflow-y-auto pr-2" role="listbox">
          </ul>
      </section>

      <section class="w-full md:w-2/3 bg-gray-900 rounded-xl border-4 border-gray-700 p-4 overflow-y-auto" aria-label="Riproduttore e Archivio">
        <video id="videoPlayer" class="w-full bg-black mb-4 rounded-lg" style="max-height: 35vh;" controls crossorigin="anonymous"></video>

        <div class="flex flex-wrap gap-3 mb-8">
          <button id="play-pause-btn" class="btn-ctrl bg-blue-700">Play / Pausa</button>
          <button id="record-btn" class="btn-ctrl bg-purple-800">Registra 30 min</button>
          <button id="stop-record-btn" class="btn-ctrl bg-red-700">Stop Registra</button>
          <button id="update-epg-btn" class="btn-ctrl bg-teal-800">Aggiorna Guida TV</button>
          <button id="rewind-btn" class="btn-ctrl bg-orange-800">- 15 Secondi</button>
          <button id="forward-btn" class="btn-ctrl bg-orange-800">+ 15 Secondi</button>
          <button id="vol-up-btn" class="btn-ctrl bg-gray-700">Volume +</button>
          <button id="vol-down-btn" class="btn-ctrl bg-gray-700">Volume -</button>
        </div>

        <hr class="border-gray-700 mb-6">

        <h2 class="text-2xl font-bold text-purple-400 mb-4">I tuoi file salvati (Ultimi 7 giorni)</h2>
        <div id="recList" class="space-y-3">
          </div>
      </section>
    </div>
  </main>

  <script>
    // --- CONFIGURAZIONE ---
    const SERVER_IP = "http://138.199.196.24:3000";
    const TOKEN = "42944"; // La tua parola segreta

    const video = document.getElementById('videoPlayer');
    const statusArea = document.getElementById('statusArea');
    const srAnnouncer = document.getElementById('sr-announcer');
    const listContainer = document.getElementById('channelList');
    const mainSearch = document.getElementById('mainSearch');
    const recListContainer = document.getElementById('recList');

    let allChannels = [];
    let currentUrl = "";
    let currentChName = "";
    let hlsInstance = null;

    // Funzione per feedback vocale agli screen reader
    function announce(msg) {
      srAnnouncer.textContent = "";
      setTimeout(() => { srAnnouncer.textContent = msg; }, 100);
    }

    // Caricamento Iniziale
    async function init() {
      try {
        const urlM3U = "https://raw.githubusercontent.com/lellivalentina1992-lang/tv/refs/heads/main/lista_personale.m3u";
        const res = await fetch(`${SERVER_IP}/m3u?token=${TOKEN}&url=${encodeURIComponent(urlM3U)}`);
        const data = await res.text();
        
        parseM3U(data);
        renderList("");
        updateRecList();
        statusArea.textContent = "Sistema Online. 20TB di banda disponibili.";
      } catch (e) {
        announce("Errore di connessione al server Hetzner. Controlla il token o l'indirizzo IP.");
      }
    }

    function parseM3U(data) {
      const lines = data.split('\n');
      let name = "";
      lines.forEach(line => {
        line = line.trim();
        if (line.startsWith("#EXTINF:")) name = line.split(',').pop().trim();
        else if (line.startsWith("http") && name) {
          allChannels.push({ pretty: name, url: line });
          name = "";
        }
      });
    }

    function renderList(query) {
      listContainer.innerHTML = "";
      const filtered = allChannels.filter(c => c.pretty.toLowerCase().includes(query.toLowerCase()));
      
      filtered.slice(0, 60).forEach(ch => {
        const li = document.createElement('li');
        const btn = document.createElement('button');
        btn.className = "btn-channel";
        btn.textContent = ch.pretty;
        btn.onclick = () => {
          currentUrl = ch.url;
          currentChName = ch.pretty;
          playSource(ch.url, ch.pretty);
        };
        li.appendChild(btn);
        listContainer.appendChild(li);
      });
    }

    async function playSource(url, nome) {
      statusArea.textContent = `Caricamento: ${nome}...`;
      
      // Recupera info Guida TV se disponibile
      try {
        const infoRes = await fetch(`${SERVER_IP}/info-programma?token=${TOKEN}&nome=${encodeURIComponent(nome)}`);
        const infoData = await infoRes.json();
        if (infoData.titolo) {
          announce(`In onda su ${nome}: ${infoData.titolo}`);
          statusArea.textContent = `In onda: ${nome} - ${infoData.titolo}`;
        } else {
          announce(`Riproduzione avviata: ${nome}`);
        }
      } catch (e) { announce(`Avviato ${nome}`); }

      if (hlsInstance) hlsInstance.destroy();

      if (url.includes(".m3u8") && Hls.isSupported()) {
        hlsInstance = new Hls();
        hlsInstance.loadSource(url);
        hlsInstance.attachMedia(video);
        hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => video.play());
      } else {
        video.src = url;
        video.play().catch(() => announce("Errore: Impossibile riprodurre questo link."));
      }
    }

    // Gestione Archivio
    async function updateRecList() {
      try {
        const res = await fetch(`${SERVER_IP}/lista-registrazioni?token=${TOKEN}`);
        const files = await res.json();
        recListContainer.innerHTML = files.length ? "" : "<p class='text-gray-500'>Nessuna registrazione negli ultimi 7 giorni.</p>";
        
        files.reverse().forEach(f => {
          const item = document.createElement('div');
          item.className = "bg-gray-800 p-4 rounded-xl flex justify-between items-center border-l-8 border-purple-600 shadow-lg";
          item.innerHTML = `
            <span class="text-xl font-bold">${f.nome.split('_')[0]}</span>
            <div class="flex gap-2">
              <button onclick="playSource('${f.url}', 'Registrazione')" class="bg-blue-600 p-3 rounded-lg font-bold">Ascolta</button>
              <a href="${f.url}" download class="bg-green-700 p-3 rounded-lg font-bold">Scarica</a>
            </div>
          `;
          recListContainer.appendChild(item);
        });
      } catch (e) { console.error("Errore archivio"); }
    }

    // --- AZIONI BOTTONI ---

    document.getElementById('update-epg-btn').onclick = async () => {
      announce("Download della guida TV in corso dal server Hetzner...");
      try {
        const res = await fetch(`${SERVER_IP}/scarica-guida?token=${TOKEN}`);
        const data = await res.json();
        announce(data.msg); // Annuncia "Guida TV aggiornata e pronta"
      } catch (e) { announce("Errore nel download della guida."); }
    };

    document.getElementById('record-btn').onclick = async () => {
      if (!currentUrl) return announce("Seleziona prima un canale.");
      
      // Controllo spazio disco preventivo
      const disk = await (await fetch(`${SERVER_IP}/stato-disco?token=${TOKEN}`)).json();
      if (disk.pieno) return announce(`Errore: Spazio insufficiente sul server. Rimangono solo ${disk.libero} GB.`);

      announce(`Avvio registrazione di ${currentChName} per 30 minuti.`);
      const res = await fetch(`${SERVER_IP}/registra?token=${TOKEN}&url=${encodeURIComponent(currentUrl)}&nome=${encodeURIComponent(currentChName)}`);
      const data = await res.json();
      statusArea.textContent = data.msg;
    };

    document.getElementById('stop-record-btn').onclick = async () => {
      announce("Invio comando di stop al server...");
      const res = await fetch(`${SERVER_IP}/stop-registra?token=${TOKEN}`);
      const data = await res.json();
      announce(data.msg);
      setTimeout(updateRecList, 2000); // Aggiorna lista dopo il salvataggio
    };

    // Controlli Riproduzione
    document.getElementById('play-pause-btn').onclick = () => {
      if (video.paused) { video.play(); announce("Play"); }
      else { video.pause(); announce("Pausa"); }
    };

    document.getElementById('rewind-btn').onclick = () => { video.currentTime -= 15; announce("Indietro 15 secondi"); };
    document.getElementById('forward-btn').onclick = () => { video.currentTime += 15; announce("Avanti 15 secondi"); };
    
    document.getElementById('vol-up-btn').onclick = () => {
      video.volume = Math.min(1, video.volume + 0.1);
      announce(`Volume ${Math.round(video.volume * 100)} percento`);
    };
    document.getElementById('vol-down-btn').onclick = () => {
      video.volume = Math.max(0, video.volume - 0.1);
      announce(`Volume ${Math.round(video.volume * 100)} percento`);
    };

    // Ricerca e scorciatoia
    mainSearch.oninput = (e) => renderList(e.target.value);
    window.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === 's') { e.preventDefault(); mainSearch.focus(); announce("Cerca canale attiva."); }
    });

    // Avvio Sistema
    init();
    // Aggiorna automaticamente l'archivio ogni minuto
    setInterval(updateRecList, 60000);
  </script>
</body>
</html>