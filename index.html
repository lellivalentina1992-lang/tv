<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TV ULTRA PRO - Valentina</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body { font-family: system-ui, sans-serif; background: #000; color: #fff; margin: 0; padding: 15px; }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }
        
        .panel { background: #1a1a1a; padding: 20px; border-radius: 15px; border: 2px solid #333; margin-bottom: 20px; }
        .setup-panel { border-color: #3b82f6; }
        .record-panel { border-color: #fbbf24; }
        
        label { display: block; margin: 15px 0 5px; color: #fbbf24; font-weight: bold; font-size: 1.2rem; }
        input, select { width: 100%; padding: 18px; font-size: 1.4rem; border-radius: 10px; background: #111; color: #fff; border: 2px solid #444; box-sizing: border-box; }
        
        .btn { width: 100%; padding: 20px; font-size: 1.3rem; font-weight: bold; border-radius: 12px; border: none; cursor: pointer; margin-top: 10px; }
        .btn-primary { background: #fbbf24; color: #000; }
        .btn-secondary { background: #10b981; color: #fff; }
        .btn-channel { text-align: left; background: #1e293b; color: #fff; margin-bottom: 8px; border-left: 5px solid #3b82f6; }
        
        #playerContainer { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 12px; overflow: hidden; display: none; margin-bottom: 15px; border: 1px solid #333; }
        video { width: 100%; height: 100%; }

        details { background: #222; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #444; }
        summary { font-size: 1.2rem; font-weight: bold; color: #fbbf24; cursor: pointer; }
    </style>
</head>
<body>

    <div id="announcer" class="sr-only" aria-live="assertive"></div>

    <h1 class="sr-only">TV ULTRA PRO - Applicazione Valentina</h1>

    <details class="setup-panel" open>
        <summary>⚙️ Configurazione Server</summary>
        <div role="group" aria-label="Impostazioni Server">
            <label for="serverUrl">Indirizzo Server Hetzner:</label>
            <input type="url" id="serverUrl" value="http://138.199.196.24:3000">
            
            <label for="serverPin">PIN Segreto:</label>
            <input type="password" id="serverPin" value="42944">
        </div>
    </details>

    <section class="panel" role="search">
        <label for="searchBox">Cerca Canale (es. Rai, Mediaset, Lazio):</label>
        <input type="search" id="searchBox" placeholder="Scrivi il nome...">
        <div id="status" style="color:#fbbf24; margin-top:10px; font-weight:bold;" aria-live="polite">Caricamento liste...</div>
    </section>

    <section>
        <div id="playerContainer">
            <video id="videoPlayer" controls playsinline crossorigin="anonymous"></video>
        </div>
        <button id="nextSourceBtn" class="btn btn-secondary" style="display:none;">⚠️ Audio scarso? Prova altra sorgente</button>
    </section>

    <section id="recordPanel" class="panel record-panel" style="display:none;">
        <h2 id="currentChannelLabel">Registrazione</h2>
        
        <label for="regHour">Ora di inizio:</label>
        <select id="regHour" aria-label="Seleziona ora"></select>

        <label for="regMin">Minuto di inizio (ogni 5 minuti):</label>
        <select id="regMin" aria-label="Seleziona minuti"></select>

        <label for="regDuration">Durata totale (minuti):</label>
        <input type="number" id="regDuration" value="60" aria-label="Durata in minuti">

        <button id="confirmRecordBtn" class="btn btn-primary">Pianifica Registrazione su Hetzner</button>
    </section>

    <nav id="channelList" aria-label="Elenco canali"></nav>

    <script>
        const PLAYLISTS = [
            "https://raw.githubusercontent.com/lellivalentina1992-lang/tv/refs/heads/main/lista_personale.m3u",
            "https://raw.githubusercontent.com/df-fulgi/iptv/master/italy.m3u",
            "https://iptv-org.github.io/iptv/languages/ita.m3u"
        ];

        let channelsDb = {};
        let activeChannel = "";
        let sourceIndex = 0;
        let hlsInstance = null;

        function comunica(t) {
            const a = document.getElementById('announcer');
            a.textContent = "";
            setTimeout(() => { a.textContent = t; }, 100);
        }

        // Popolamento selettori (passi da 5 min)
        const hSel = document.getElementById('regHour');
        for(let i=0; i<24; i++) {
            let v = i.toString().padStart(2, '0');
            hSel.add(new Option(v, v));
        }
        const mSel = document.getElementById('regMin');
        for(let i=0; i<60; i+=5) {
            let v = i.toString().padStart(2, '0');
            mSel.add(new Option(v, v));
        }

        async function init() {
            for (const url of PLAYLISTS) {
                try {
                    const r = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`);
                    const txt = await r.text();
                    parseM3U(txt);
                } catch (e) {}
            }
            document.getElementById('status').textContent = "Pronto. Valentina, scegli un canale.";
            render("");
        }

        function parseM3U(txt) {
            const lines = txt.split('\n');
            let name = "";
            lines.forEach(l => {
                if (l.startsWith("#EXTINF:")) name = l.split(',').pop().trim().toUpperCase();
                else if (l.startsWith("http") && name) {
                    if (!channelsDb[name]) channelsDb[name] = [];
                    channelsDb[name].push(l.trim());
                }
            });
        }

        function render(f) {
            const list = document.getElementById('channelList');
            list.innerHTML = "";
            Object.keys(channelsDb).filter(k => k.includes(f.toUpperCase())).sort().slice(0, 40).forEach(n => {
                const b = document.createElement('button');
                b.className = "btn btn-channel";
                b.textContent = n;
                b.onclick = () => play(n);
                list.appendChild(b);
            });
        }

        function play(n) {
            activeChannel = n;
            sourceIndex = 0;
            loadSource(channelsDb[n][0]);
            
            document.getElementById('playerContainer').style.display = "block";
            document.getElementById('recordPanel').style.display = "block";
            document.getElementById('nextSourceBtn').style.display = channelsDb[n].length > 1 ? "block" : "none";
            document.getElementById('currentChannelLabel').textContent = "Canale: " + n;
            comunica("In onda: " + n + ". Usa il pannello sotto il video per registrare.");
        }

        function loadSource(url) {
            const video = document.getElementById('videoPlayer');
            if (hlsInstance) { hlsInstance.destroy(); }
            
            if (Hls.isSupported()) {
                hlsInstance = new Hls();
                hlsInstance.loadSource(url);
                hlsInstance.attachMedia(video);
                hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => video.play());
            } else {
                video.src = url;
                video.play();
            }
        }

        document.getElementById('nextSourceBtn').onclick = () => {
            sourceIndex = (sourceIndex + 1) % channelsDb[activeChannel].length;
            loadSource(channelsDb[activeChannel][sourceIndex]);
            comunica("Sorgente cambiata. Tentativo numero " + (sourceIndex + 1));
        };

        document.getElementById('confirmRecordBtn').onclick = async () => {
            const server = document.getElementById('serverUrl').value;
            const pin = document.getElementById('serverPin').value;
            
            const payload = {
                url: channelsDb[activeChannel][sourceIndex],
                channelName: activeChannel,
                time: `${hSel.value}:${mSel.value}`,
                duration: document.getElementById('regDuration').value,
                pin: pin,
                backupUrls: channelsDb[activeChannel]
            };

            try {
                const r = await fetch(`${server}/api/record-scheduled`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (r.ok) {
                    comunica("Successo! Registrazione di " + activeChannel + " programmata alle ore " + payload.time);
                } else {
                    comunica("Errore. Controlla il PIN nel server.");
                }
            } catch (e) {
                comunica("Server Hetzner non raggiungibile.");
            }
        };

        document.getElementById('searchBox').oninput = (e) => render(e.target.value);
        init();
    </script>
</body>
</html>