<!DOCTYPE html>
<html lang="it" class="h-full bg-black text-white">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TV/Radio ULTRA - Accesso Totale</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        /* Focus ultra-visibile per navigazione da tastiera */
        :focus { outline: 8px solid #fbbf24 !important; outline-offset: 4px; background-color: #1e40af !important; }
        .btn-ctrl { flex: 1 1 45%; min-height: 80px; font-weight: bold; font-size: 1.4rem; border-radius: 15px; }
        .btn-channel { width: 100%; text-align: left; background: #1f2937; padding: 1.5rem; border-radius: 12px; font-weight: bold; font-size: 1.6rem; border: 2px solid #374151; margin-bottom: 0.8rem; display: block; }
        .tag-tipo { color: #fbbf24; border: 1px solid #fbbf24; padding: 2px 6px; border-radius: 4px; margin-right: 10px; font-size: 1rem; vertical-align: middle; }
    </style>
</head>
<body class="h-full flex flex-col font-sans overflow-hidden">

    <div id="sr-announcer" class="sr-only" aria-live="assertive" aria-atomic="true"></div>

    <main class="flex-1 flex flex-col p-4 overflow-hidden">
        
        <section class="mb-4" role="search">
            <label for="mainSearch" class="block text-xl font-bold mb-2 text-yellow-500">Cerca Canale (Ctrl+S):</label>
            <input type="search" id="mainSearch" 
                   class="w-full bg-gray-900 p-5 rounded-xl border-4 border-blue-600 text-white text-3xl focus:border-yellow-500" 
                   placeholder="Scrivi qui (es: Rai, Mediaset, Lazio)..." autocomplete="off">
        </section>

        <div class="flex-1 flex flex-col md:flex-row gap-4 overflow-hidden">
            <section class="w-full md:w-1/2 flex flex-col overflow-hidden" aria-label="Elenco canali">
                <div id="statusArea" class="p-2 text-yellow-400 font-bold text-lg" aria-live="polite">
                    Inizializzazione database...
                </div>
                <ul id="channelList" class="flex-1 overflow-y-auto pr-2" role="listbox">
                    </ul>
            </section>

            <section class="w-full md:w-1/2 bg-gray-900 rounded-2xl flex flex-col border-2 border-gray-700 overflow-hidden" aria-label="Player e controlli">
                <video id="videoPlayer" class="w-full bg-black" style="height: 30vh;" controls crossorigin="anonymous"></video>
                
                <div class="p-4 flex flex-wrap gap-3 overflow-y-auto">
                    <button id="play-pause-btn" class="btn-ctrl bg-blue-700">Play / Pausa</button>
                    <button id="vol-up-btn" class="btn-ctrl bg-gray-700">Volume +</button>
                    <button id="vol-down-btn" class="btn-ctrl bg-gray-700">Volume -</button>
                    <button id="copy-btn" class="btn-ctrl bg-green-800">Copia Link</button>
                    <button id="reset-btn" class="btn-ctrl bg-red-900">Svuota Cerca</button>
                </div>
            </section>
        </div>
    </main>

    <script>
        const video = document.getElementById('videoPlayer');
        const listContainer = document.getElementById('channelList');
        const mainSearch = document.getElementById('mainSearch');
        const statusArea = document.getElementById('statusArea');
        const srAnnouncer = document.getElementById('sr-announcer');

        let allChannels = []; 
        let currentUrl = "";
        let hlsInstance = null;

        const proxy = "https://corsproxy.io/?";

        // Liste integrate da Tv.html e dalle sorgenti precedenti
        const m3uSources = [
            "https://raw.githubusercontent.com/lellivalentina1992-lang/tv/refs/heads/main/lista_personale.m3u",
            "http://inthemix.altervista.org/tv.m3u",
            "https://tivustream.website/urls/listm3u",
            "https://pastebin.com/raw/8GpCCkhf",
            "https://pastebin.com/raw/aRYDYSEQ",
            "https://bit.ly/itatv",
            "https://iptv-org.github.io/iptv/languages/ita.m3u",
            "https://pastebin.com/raw/sG5cusFp/.m3u",
            "http://www.pandasat.info/iptv/kodi",
            "https://raw.githubusercontent.com/Tundrak/IPTV-Italia/main/iptvita.m3u"
        ];

        async function init() {
            announce("Caricamento di tutte le liste in corso. Attendi.");
            
            // Canale manuale Lazio Style
            addChannel('Lazio Style Radio', 'https://sslazio.fluidstream.eu/sslazio.mp3', 'RADIO');

            const fetchPromises = m3uSources.map(async (src) => {
                try {
                    const res = await fetch(proxy + encodeURIComponent(src));
                    if (res.ok) {
                        const data = await res.text();
                        parseM3U(data);
                        renderList(mainSearch.value); // Aggiorna la vista mentre carica
                    }
                } catch (e) { console.warn("Sorgente non raggiungibile:", src); }
            });

            await Promise.all(fetchPromises);
            
            statusArea.textContent = `Database Pronto: ${allChannels.length} canali.`;
            announce(`Caricamento completato. Trovati ${allChannels.length} canali totali dalle tue liste.`);
        }

        function parseM3U(data) {
            const lines = data.split('\n');
            let currentName = "";
            lines.forEach(line => {
                line = line.trim();
                if (line.startsWith("#EXTINF:")) {
                    currentName = line.split(',').pop().trim();
                } else if (line.startsWith("http") && currentName) {
                    addChannel(currentName, line);
                    currentName = "";
                }
            });
        }

        function addChannel(name, url, type = null) {
            const cleanName = name.replace(/\[.*?\]/g, "").trim();
            const key = cleanName.toLowerCase().replace(/\s+/g, '');
            if (!type) type = (url.includes(".mp3") || cleanName.toLowerCase().includes("radio")) ? "RADIO" : "TV";
            
            const existing = allChannels.find(c => c.key === key);
            if (existing) {
                if (!existing.urls.includes(url)) existing.urls.push(url);
            } else {
                allChannels.push({ key, pretty: cleanName, urls: [url], type });
            }
        }

        function renderList(query) {
            listContainer.innerHTML = "";
            const filtered = allChannels
                .filter(c => c.pretty.toLowerCase().includes(query.toLowerCase()))
                .sort((a, b) => a.pretty.localeCompare(b.pretty));

            // Mostriamo i primi 200 per fluiditÃ  dello screen reader
            filtered.slice(0, 200).forEach((ch) => {
                const li = document.createElement('li');
                li.setAttribute("role", "none");
                const btn = document.createElement('button');
                btn.className = "btn-channel";
                btn.setAttribute("role", "option");
                btn.innerHTML = `<span class="tag-tipo">${ch.type}</span> ${ch.pretty}`;
                btn.onclick = () => playSource(ch.pretty, ch.urls);
                li.appendChild(btn);
                listContainer.appendChild(li);
            });

            if (query !== "") {
                announce(`Trovati ${filtered.length} canali.`);
            }
        }

        async function playSource(name, urls) {
            statusArea.textContent = `Connessione a ${name}...`;
            announce(`Provo a caricare ${name}`);

            for (let url of urls) {
                const success = await tryPlay(url);
                if (success) {
                    currentUrl = url;
                    statusArea.textContent = `In onda: ${name}`;
                    announce(`Riproduzione avviata.`);
                    return;
                }
            }
            statusArea.textContent = "Errore: Canale non disponibile.";
            announce("Nessun link funzionante per questo canale.");
        }

        function tryPlay(url) {
            return new Promise((resolve) => {
                if (hlsInstance) hlsInstance.destroy();
                video.pause();
                const timer = setTimeout(() => resolve(false), 8000);

                if (url.includes(".m3u8")) {
                    if (Hls.isSupported()) {
                        hlsInstance = new Hls();
                        hlsInstance.loadSource(url);
                        hlsInstance.attachMedia(video);
                        hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => {
                            clearTimeout(timer);
                            video.play().then(() => resolve(true)).catch(() => resolve(false));
                        });
                        hlsInstance.on(Hls.Events.ERROR, () => resolve(false));
                    }
                } else {
                    video.src = url;
                    video.play().then(() => { clearTimeout(timer); resolve(true); }).catch(() => resolve(false));
                }
            });
        }

        function announce(msg) {
            srAnnouncer.textContent = "";
            setTimeout(() => { srAnnouncer.textContent = msg; }, 100);
        }

        // Shortcut tastiera
        window.onkeydown = (e) => {
            if (e.ctrlKey && e.key.toLowerCase() === 's') {
                e.preventDefault();
                mainSearch.focus();
                announce("Ricerca attiva. Scrivi il nome di un canale.");
            }
        };

        // Eventi Bottoni
        document.getElementById('play-pause-btn').onclick = () => {
            video.paused ? video.play() : video.pause();
            announce(video.paused ? "Pausa" : "Play");
        };
        document.getElementById('vol-up-btn').onclick = () => { 
            video.volume = Math.min(1, video.volume + 0.1); 
            announce(`Volume ${Math.round(video.volume * 100)}`);
        };
        document.getElementById('vol-down-btn').onclick = () => { 
            video.volume = Math.max(0, video.volume - 0.1); 
            announce(`Volume ${Math.round(video.volume * 100)}`);
        };
        document.getElementById('copy-btn').onclick = () => {
            if (currentUrl) {
                navigator.clipboard.writeText(currentUrl);
                announce("Link copiato.");
            }
        };
        document.getElementById('reset-btn').onclick = () => {
            mainSearch.value = "";
            renderList("");
            mainSearch.focus();
            announce("Ricerca svuotata.");
        };

        mainSearch.oninput = (e) => renderList(e.target.value);

        init();
    </script>
</body>
</html>